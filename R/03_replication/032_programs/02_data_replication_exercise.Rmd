---
title: "SPI Data Documentation"
author: "Brian Stacy"
date: "`r Sys.Date()`"
output: 
  html_document: 
    fig_height: 6
    fig_width: 8
    keep_md: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load Packages
library(tidyverse)
library(skimr)
library(kableExtra)
library(readxl)
library(Hmisc)
library(haven)
library(httr)
library(rsdmx)
# Directory for SPI csv files that were previously created
csv_dir <- "C:/Users/wb469649/Documents/Github/SPI_AKI/R/03_replication/031_rawdata"

# Directory for SPI csv files that are saved
csv_output <- "C:/Users/wb469649/Documents/Github/SPI_AKI/R/03_replication/033_outputs"

```

# Introduction

This file will clean the raw SPI data and form the SPI indicators.  From the original technical report on the SPI:

Once the dimensions have been specified, attention turns to identifying the variables and selecting an appropriate aggregation method. The criteria suggest that the variables in an index should be coherent with the concept being measured; they should be publicly available (i.e., drawn from NSSs, rather than from experts or other sources). The aggregation method should be selected with rigor in mind, including the axioms or properties that the method satisfies. At the same time, it should aim for simplicity to maximize general understanding and impact.

A variable is typically derived from a simple “yes-no” question concerning a normative guideline that a country’s NSS should meet.  Each of these “yes-no” questions generate a dichotomous variable having a 0-1 representation.  In the case of SPI, in Dimensions 1 and a part of Dimension 2 the yes-no questions generate three variables with 0-0.5-1 representation, while in the second half of Dimension 2 it has a 0-0.3-0.6-1 representation, and in dimensions 3 and 4 it generates a variable having a 0-1 representation.

Dimension  Score=Weighted Score÷Maximum Dimension Score×100

The indicator selection process is guided by conventions of international agencies, expert opinions on statistical performance and the principles of SDGs. However, given the cost and time constraints and the accuracy concerns of assessment, trade-offs have to be made to build an actionable, cost-effective and internationally comparable index. 

One such trade-off is the equal weighting of each dimension and individual indicator, even though some of them may be more important than others or countries may assign higher priority to some than others. The equal weighting selection may be, to some extent subjective, partly failing to address the relative importance of the dimensions and indicators. This could be checked by simulations that will show the sensitivity of SPI scores and rankings in relation to alternative weights. 

When variables are dichotomous (or can be dichotomized), a measurement approach called a “counting method” is applicable and, indeed, has become standard for many types of measurement exercises. This method is used here to aggregate the scores of four dimensions into an overall SPI score and to create the composite index. Hence:

Total SPI Score =(MSC+CS+DPO+AKI)/4

Each of the four dimensions has a scale of 1-100 and are aggregated into a total score which also ranges from 1 to 100.  More information on the theoretical aspects of the SPI can be found in Cameron et al (2019).


# Data

Raw data can be found in 011_rawdata folder of this directory.  Below is documentation.


| SPI Concept                                                                                                        | File Name            | Variable Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ------------------------------------------------------------------------------------------------------------------ | -------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.1 System of National Accounts in use                                                                             | D1.1.MSC.SNAU.csv    | SNAU - The national accounts data are compiled using the concepts, definitions, framework, and methodology of the System of National Account 2008 (SNA2008) or European System of National and Regional Accounts (ESA 2010).  The manual has evolved to meet the changing economic structure, to follow systematic accounting and ensure international compatibility.                                                                                                                                                                                                                                                                                                                                                                                                |
| 1.2 National Accounts base year                                                                                    | D1.2.MSC.NABY.csv    | NABY - National accounts base year is the year used as the base period for constant price calculations in the country’s national accounts.  It is recommended that the base year of constant price estimates be changed periodically to reflect changes in economic structure and relative prices.                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| 1.3 Classification of national industry                                                                            | D1.3.MSC.CNIN.csv    | The industrial production data are compiled using the International Standard Industrial Classification of All Economic Activities (ISIC) Rev.4 and Statistical Classification of Economic Activities in the European Community (NACE) Rev.2.  ISIC Rev.4 is a standard classification of economic activities arranged so that entities can be classified per the activity they carry out using criteria such as input, output and use of the products produced, more emphasis has been given to the character of the production process in defining and delineating ISIC classes for international comparability.  The manual and classification have changed to cover the complete scope of industrial production, employment, and GDP and other statistical areas. |
| 1.4 CPI base year                                                                                                  | D1.4.MSC.CPIBY.csv   | Consumer Price Index serves as indicators of inflation and reflects changes in the cost of acquiring a fixed basket of goods and services by the average consumer.  Weights are usually derived from consumer expenditure surveys and the CPI base year refers to the year the weights were derived.  It is recommended that the base year be changed periodically to reflect changes in expenditure structure.                                                                                                                                                                                                                                                                                                                                                      |
| 1.5. Classification of household consumption.                                                                      | D1.5.MSC.HOUS.csv    | Classification of Individual Consumption According to Purpose (COICOP) is used in household budget surveys, consumer price indices and international comparisons of gross domestic product (GDP) and its component expenditures.  Although COICOP is not strictly linked to any particular model of consumer behavior, the classification is designed to broadly reflect differences in income elasticities.  It is an integral part of the SNA1993 and more detailed subdivision of the classes provide comparability between countries and between statistics in these different areas.                                                                                                                                                                            |
| 1.6 Classification of status of employment                                                                         | D1.6.MSC.EMPL.csv    | Classification of status of employment refers to employment data that are compiled using the current international standard International Classification of Status in Employment (ISCE-93).  It classifies jobs with respect to the type of explicit or implicit contract of employment between the job holder and the economic unit in which he or she is employed.  Therefore, it aims to provide the basis for production of internationally comparable statistics on the employment relationship, including the distinction between salaried employment and self-employment.                                                                                                                                                                                     |
| 1.7 Central government accounting status                                                                           | D1.7.MSC.CGOV.csv    | Government finance accounting status refers to the accounting basis for reporting central government financial data.  For many countries’ government finance data, have been consolidated into one set of accounts capturing all the central government’s fiscal activities and following noncash recording basis.  Budgetary central government accounts do not necessarily include all central government units, the picture they provide of central government activities is usually incomplete.                                                                                                                                                                                                                                                                  |
| 1.8. Compilation of government finance statistics.                                                                 | D1.8.MSC.FINA.csv    | (GFSM) in use for compiling the data.  It provides guidelines on the institutional structure of governments and the presentation of fiscal data in a format similar to business accounting with a balance sheet and income statement plus guidelines on the treatment of exchange rate and other valuation adjustments.  The latest manual GFSM2014 is harmonized with the SNA2008.                                                                                                                                                                                                                                                                                                                                                                                  |
| 1.9 Compilation of monetary and financial statistics                                                               | D1.9.MSC.MONY.csv    | Compilation of monetary and financial statistics refers to the Monetary and Financial Statistics Manual (MFSM) in use.  It covers concepts, definitions, classifications of financial instruments and sectors, and accounting rules, and provides a comprehensive analytic framework for monetary and financial planning and policy determination.  The Monetary and Finance Statistics: Compilation Guide (2008) provides detailed guidelines for the compilation of monetary and financial statistics in addition to MFSM.                                                                                                                                                                                                                                         |
| 1.10. SDDS/e-GDDS subscription.                                                                                    | D1.10.MSC.IDDS.csv   | The Special Data Dissemination Standard (SDDS) and electronic General Data Dissemination Standard (e-GDDS) were established by the International Monetary Fund (IMF) for member countries that have or that might seek access to international capital markets, to guide them in providing their economic and financial data to the public.  Although subscription is voluntary, the subscribing member needs to be committed to observing the standard and provide information about its data and data dissemination practices (metadata).  The metadata are posted on the IMF’s SDDS and e-GDDS websites.                                                                                                                                                          |
| 1.11 CRVS                                                                                                          | D1.11.MSC.CRVS.csv   | Civil registration and vital statistics record the occurrence and characteristics of vital events (births, deaths, marriage and divorce etc.) pertaining to the population and serve as a main source of vital statistics. This identifies countries that report at least 90 percent complete registries of vital (birth and death) statistics to the United Nations Statistics Division and are reported in its Population and Vital Statistics Reports. Countries with complete vital statistics registries may have more accurate and timely demographic indicators.                                                                                                                                                                                              |
| 1.12 Business process                                                                                              | D1.12.MSC.GSBP.csv   | GSBP The Generic Statistical Business Process Model (GSBPM) aims to describe statistics production in a general and process-oriented way.  It is used both within and between statistical offices as a common basis for work with statistics production in different ways, such as quality, efficiency, standardization, and process-orientation.  It is used for all types of surveys, and "business" is not related to "business statistics" but refers to the statistical office, simply expressed.                                                                                                                                                                                                                                                               |
| 2.1 Population & Housing census                                                                                    | D2.1.CEN.POPU.csv    | Population censuses collect data on the size, distribution and composition of population and information on a broad range of social and economic characteristics of the population.  It also provides sampling frames for household and other surveys.  Housing censuses provide information on the supply of housing units, the structural characteristics and facilities, and health and the development of normal family living conditions.  Data obtained as part of the population census, including data on homeless persons, are often used in the presentation and analysis of the results of the housing census.  It is recommended that population and housing censuses be conducted at least every 10 years.                                              |
| 2.2 Agriculture census                                                                                             | D2.2.CEN.AGRI.csv    | Agriculture censuses collect information on agricultural activities, such as size of holding, land tenure, land use, employment and production, and provide basic structural data and sampling frames for agricultural surveys.  Censuses of agriculture normally involves collecting key structural data by complete enumeration of all agricultural holdings, in combination with more detailed structural data using sampling methods.  It is recommended that agricultural censuses be conducted at least every 10 years.                                                                                                                                                                                                                                        |
| 2.3 Business/establishment census                                                                                  | D2.3.CEN.BIZZ.csv    | Business/establishment censuses provide valuable information on all economic activities, number of employed and size of establishments in the economy.  Business Register information is establishment-based and includes business location, organization type (e.g. subsidiary or parent), industry classification, and operating data (e.g., receipts and employment).                                                                                                                                                                                                                                                                                                                                                                                             |
| 2.4 Household survey on income/consumption/expenditure/budget/integrated survey.                                   | D2.4.SVY.HOUS.csv    | These surveys collect data on household income (including income in kind), consumption and expenditure.  They typically include income, expenditure, and consumption surveys, household budget surveys, integrated surveys.  It is recommended that surveys on income and expenditure be conducted at least every 3 to 5 years.                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 2.5 Agriculture survey.                                                                                            |                      | Agricultural surveys refer to surveys of agricultural holdings based on the sampling frames established by the agricultural census.  These are surveys on agricultural land, production, crops and livestock, aquaculture, labor and cost, and time use.  Some issues, such as gender and food security, are of interest to most agriculture surveys.                                                                                                                                                                                                                                                                                                                                                                                                                |
| 2.6 Labor Force Survey                                                                                             | D2.6.SVY.LABR.csv    | Labor force survey is a standard household-based survey of work-related statistics at the national and sub-national employment or unemployment levels, rates or trends.  The surveys also provide the characteristics of the employed or unemployed, including labor force status by age or gender, breakdowns between employees and the self-employed, public versus private sector employment, multiple job-holding, hiring, job creation, and duration of unemployment.                                                                                                                                                                                                                                                                                           |
| 2.7 Health/demographic survey                                                                                      | D2.7.SVY.HLTH.csv    | Health surveys collect information on various aspects of health of populations, such as health expenditure, access, utilization, and outcomes.  They typically include Demographic and Health Surveys.  It is recommended that health surveys be conducted at least every 3 to 5 years.                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 2.8 Business/establishment survey                                                                                  | D2.8.SVY.BIZZ.csv    | The business/establishment survey provides information on employment, hours, and earnings of employees from a sample of business establishments including private and public, entities that are classified based on an establishment's principal activity from the business or establishment census.  Establishment surveys include surveys of businesses, farms, and institutions.  They may ask for information about the establishment itself and/or employee characteristics and demographics.                                                                                                                                                                                                                                                                   |
| 4.1 NSO has an Advance Release Calendar and it is published                                                        | D4.1.SC.DPO.CALD.csv | This indicator refers to a dissemination practice for relevant statistical data in accordance to the published advance release calendar.  Its presence provides information on upcoming releases in advance and creates public awareness; this will lead to more discipline and accountability from the statistical office.                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 4.2 NSO has a listing of surveys and/ or microdata sets (or NADA) available upon request.                          | D4.2.SC.DPO.NADA.csv | NSO has a listing of surveys and microdata sets that can provide the necessary data and reference for follow-up.  Upon well-defined request and procedure per the national law and practice, users and practitioners can obtain the data collected from the households and businesses when needed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| 4.3 NSO has a data portal                                                                                          | D4.3.SC.DPO.PORT.csv | This indicator refers to a web-based or stand-alone platform or tools that is maintained by the NSO and provides access to the indicators and related metadata in systematic way.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 4.4 Timeseries indicators are available for download in reusable format for free                                   | D4.4.SC.DPO.TIME.csv | This indicator will promote usage among the users and bring accountability to the NSO.  There are several different formats in which a user can access the data, such as Excel, CSV, and API etc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 4.5 Metadata is available providing definition, methodology, standards or classifications for existing data series | D4.5.SC.DPO.META.csv | Statistical systems must be open and transparent about their methods and procedures and provide access to adequate metadata – detailed descriptions of the methods and procedures used to produce the data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 4.6 NSO has conducted a user satisfaction survey                                                                   | D4.6.SC.DPO.USER.csv | Through this indicator a NSO can improve its engagement and dissemination practice by seeking regular feedback from users and then making necessary adjustments.  It is also a good practice to continually monitor the changing data landscape and user needs as well as evolving technologies.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 4.7 Geospatial data available on relevant agency website.                                                                                                                   |  D4.7.SC.DPO.GEOS.csv                    |    Geospatial data available on relevant agency website refers to geo-referenced, location-based disaggregated data from satellite.  Geospatial data are often used in combination with administrative level national and sub-national units.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
# Indicator Cleaning

## SPI Dimension 1: Methodology, Standards and Classifications (MSC): 
### 1.1 System of National Accounts in use

 The national accounts data are compiled using the concepts, definitions, 
 framework, and methodology of the System of National Account 2008 (SNA2008) 
 or European System of National and Regional Accounts (ESA 2010).  The manual 
 has evolved to meet the changing economic structure, to follow systematic accounting 
 and ensure international compatibility. 
 
 Scoring: 1 point for using SNA2008 or ESA 2010, 0.5 points for using SNA 1993 or ESA 1995, 0 points otherwise
 
```{r snau}

#read in csv file.
D1.1.MSC.SNAU <- read_csv(file = paste(csv_dir, "D1.1.MSC.SNAU.csv", sep="/" )) %>%
  mutate(SPI.D1.1.SNAU=case_when(
    SNAU=="SNA 2008" ~ 1, 
    SNAU=="SNA 1993" ~ 0.5,
    TRUE ~ 0 
  )) %>%
  arrange(date, country) %>%
  select(iso3c, country, date,SNAU, SPI.D1.1.SNAU  ) 


D1.1.MSC.SNAU_wide <- D1.1.MSC.SNAU %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('SNAU', 'SPI.D1.1.SNAU')
              )

write_excel_csv(D1.1.MSC.SNAU_wide,
                path = paste(csv_output, "D1.1.MSC.SNAU_indicator.csv", sep="/" ))
```
 

### 1.2 National Accounts base year 

National accounts base year is the year used as the base period for constant price 
calculations in the country's national accounts.  It is recommended that the base year of 
constant price estimates be changed periodically to reflect changes in economic structure and relative prices. 

1 point for chained price, 0.5 for reference period within past 10 years, 0 points otherwise.

```{r naby}

#read in csv file.
D1.2.MSC.NABY <- read_csv(file = paste(csv_dir, "D1.2.MSC.NABY.csv", sep="/" )) %>%
  mutate(SPI.D1.2.NABY=case_when(
    NABY=="Original chained constant price data are rescaled." ~ 1, 
    (date-as.numeric(NABY))<=10 ~ 0.5, #within 10 years of reference period
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, NABY, SPI.D1.2.NABY  ) %>%
  arrange(date, country)

D1.2.MSC.NABY_wide <- D1.2.MSC.NABY %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('NABY', 'SPI.D1.2.NABY')
              )

write_excel_csv(D1.2.MSC.NABY_wide,
                path = paste(csv_output, "D1.2.MSC.NABY_indicator.csv", sep="/" ))

```

### 1.3 Classification of national industry

 The industrial production data are compiled using the International Standard Industrial 
 Classification of All Economic Activities (ISIC) Rev.4 and Statistical Classification of 
 Economic Activities in the European Community (NACE) Rev.2.  ISIC Rev.4 is a standard classification 
 of economic activities arranged so that entities can be classified per the activity they carry out 
 using criteria such as input, output and use of the products produced, more emphasis has been given 
 to the character of the production process in defining and delineating ISIC classes for international 
 comparability.  The manual and classification have changed to cover the complete scope of industrial 
 production, employment, and GDP and other statistical areas.

1 Point. Latest version is adopted (ISIC Rev 4, NACE Rev 2 or a compatible classification)  

0.5 Points.  Previous version is used (ISIC Rev 3, NACE Rev 1 or a compatible classification)

0 Points. Otherwise

```{r cnin}

#read in csv file.
D1.3.MSC.CNIN <- read_csv(file = paste(csv_dir, "D1.3.MSC.CNIN.csv", sep="/" )) %>%
  mutate(SPI.D1.3.CNIN=case_when(
    str_to_lower(CNIN)=="nace rev2" | str_to_lower(CNIN)=="rev4" ~ 1, 
    str_to_lower(CNIN)=="nace rev1" | str_to_lower(CNIN)=="rev3" ~ 0.5, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, CNIN, SPI.D1.3.CNIN  ) %>%
  arrange(date, country)

D1.3.MSC.CNIN_wide <- D1.3.MSC.CNIN %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('CNIN', 'SPI.D1.3.CNIN')
              )
write_excel_csv(D1.3.MSC.CNIN_wide,
                path = paste(csv_output, "D1.3.MSC.CNIN_indicator.csv", sep="/" ))
```

### 1.4 CPI base year

Consumer Price Index serves as indicators of inflation and reflects changes in the 
 cost of acquiring a fixed basket of goods and services by the average consumer.  
 Weights are usually derived from consumer expenditure surveys and the CPI base year 
 refers to the year the weights were derived.  It is recommended that the base year be
 changed periodically to reflect changes in expenditure structure.  
 
 1 Point. Annual chain linking. 0.5 Points. Base year in last 10 years. 0 points. Otherwise
 
```{r cpiby}

#read in csv file.
D1.4.MSC.CPIBY <- read_csv(file = paste(csv_dir, "D1.4.MSC.CPIBY.csv", sep="/" )) %>%
  mutate(SPI.D1.4.CPIBY=case_when(
    CPIBY=="annual chained" ~ 1, 
    (date-as.numeric(CPIBY))<=10 ~ 0.5, #within 10 years of reference period
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, CPIBY, SPI.D1.4.CPIBY  ) %>%
  arrange(date, country)

D1.4.MSC.CPIBY_wide <- D1.4.MSC.CPIBY %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('CPIBY', 'SPI.D1.4.CPIBY')
              )

write_excel_csv(D1.4.MSC.CPIBY_wide,
                path = paste(csv_output, "D1.4.MSC.CPIBY_indicator.csv", sep="/" ))
```



 
### 1.5 Classification of household consumption

Classification of Individual Consumption According to Purpose (COICOP) 
is used in household budget surveys, consumer price indices and international 
comparisons of gross domestic product (GDP) and its component expenditures.  
Although COICOP is not strictly linked to any particular model of consumer 
behavior, the classification is designed to broadly reflect differences in 
income elasticities.  It is an integral part of the SNA1993 and more detailed 
subdivision of the classes provide comparability between countries and between 
statistics in these different areas.    

1 Point. Follow Classification of Individual Consumption by Purpose (COICOP)	0 Points.	Otherwise

```{r hous}

#read in csv file.
D1.5.MSC.HOUS <- read_csv(file = paste(csv_dir, "D1.5.MSC.HOUS.csv", sep="/" )) %>%
  mutate(SPI.D1.5.HOUS=case_when(
    HOUS=="COICOP" ~ 1, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, HOUS, SPI.D1.5.HOUS  ) %>%
  arrange(date, country)

D1.5.MSC.HOUS_wide <- D1.5.MSC.HOUS %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('HOUS', 'SPI.D1.5.HOUS')
              )

write_excel_csv(D1.5.MSC.HOUS_wide,
                path = paste(csv_output, "D1.5.MSC.HOUS_indicator.csv", sep="/" ))
```




### 1.6 Classification of status of employment 

Classification of status of employment refers to employment data that are 
 compiled using the current international standard International Classification 
 of Status in Employment (ISCE-93).  It classifies jobs with respect to the type
 of explicit or implicit contract of employment between the job holder and the 
 economic unit in which he or she is employed.  Therefore, it aims to provide the
 basis for production of internationally comparable statistics on the employment 
 relationship, including the distinction between salaried employment and self-employment.  
 
1 Point. Follow International Labour Organization, International Classification of Status in Employment (ICSE-93) or 2012 North American Industry Classification System (NAICS). 0 Points Otherwise. 
 
```{r empl}

#read in csv file.
D1.6.MSC.EMPL <- read_csv(file = paste(csv_dir, "D1.6.MSC.EMPL.csv", sep="/" )) %>%
  mutate(SPI.D1.6.EMPL=case_when(
    EMPL=="ICSE-93" | EMPL=="NAICS" ~ 1, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, EMPL, SPI.D1.6.EMPL  ) %>%
  arrange(date, country)

D1.6.MSC.EMPL_wide <- D1.6.MSC.EMPL %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('EMPL', 'SPI.D1.6.EMPL')
              )

write_excel_csv(D1.6.MSC.EMPL_wide,
                path = paste(csv_output, "D1.6.MSC.EMPL_indicator.csv", sep="/" ))
```



### 1.7 Central government accounting status

Government finance accounting status refers to the accounting basis for 
reporting central government financial data.  For many countries' government 
finance data, have been consolidated into one set of accounts capturing all 
the central government's fiscal activities and following noncash recording basis.  
Budgetary central government accounts do not necessarily include all central government 
units, the picture they provide of central government activities is usually incomplete.  

1 Point. Consolidated central government accounting follows noncash recording basis	 
0.5 Points. Consolidated central government accounting follows cash recording basis	 
0 Points. Otherwise 

```{r cgov}

#read in csv file.
D1.7.MSC.CGOV <- read_csv(file = paste(csv_dir, "D1.7.MSC.CGOV.csv", sep="/" )) %>%
  mutate(SPI.D1.7.CGOV=case_when(
    CGOV=="AC" ~ 1, 
    CGOV=="CA" ~ 0.5,
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, CGOV, SPI.D1.7.CGOV  ) %>%
  arrange(date, country)

D1.7.MSC.CGOV_wide <- D1.7.MSC.CGOV %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('CGOV', 'SPI.D1.7.CGOV')
              )

write_excel_csv(D1.7.MSC.CGOV_wide,
                path = paste(csv_output, "D1.7.MSC.CGOV_indicator.csv", sep="/" ))
```

### 1.8 Compilation of government finance statistics

(GFSM) in use for compiling the data.  It provides guidelines on the institutional 
structure of governments and the presentation of fiscal data in a format similar to 
business accounting with a balance sheet and income statement plus guidelines on the 
treatment of exchange rate and other valuation adjustments.  The latest manual GFSM2014 
is harmonized with the SNA2008. 

1 Point. Follow the latest Government Finance Statistical Manual (2014)/ ESA2010	
0.5 Points. Previous version is used (GFSM 2001)	
0 Points. Otherwise


```{r fina}

#read in csv file.
D1.8.MSC.FINA <- read_csv(file = paste(csv_dir, "D1.8.MSC.FINA.csv", sep="/" )) %>%
  mutate(SPI.D1.8.FINA=case_when(
    FINA=="2014" | FINA=="ESA 2010"~ 1, 
    FINA=="2001" ~ 0.5,
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, FINA, SPI.D1.8.FINA  ) %>%
  arrange(date, country)

D1.8.MSC.FINA_wide <- D1.8.MSC.FINA %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('FINA', 'SPI.D1.8.FINA')
              )

write_excel_csv(D1.8.MSC.FINA_wide,
                path = paste(csv_output, "D1.8.MSC.FINA_indicator.csv", sep="/" ))
```



### 1.9 Compilation of monetary and financial statistics

Compilation of monetary and financial statistics refers to the Monetary and Financial Statistics Manual 
(MFSM) in use.  It covers concepts, definitions, classifications of financial instruments and sectors, and 
accounting rules, and provides a comprehensive analytic framework for monetary and financial planning and policy 
determination.  The Monetary and Finance Statistics: Compilation Guide (2008) provides detailed guidelines for 
the compilation of monetary and financial statistics in addition to MFSM. 

1 Point. Follow the latest Monetary and Finance Statistics Manual (2000) or Monetary and Finance Statistics: Compilation Guide (2008/2016)
0 Points. Otherwise

```{r mony}

#read in csv file.
D1.9.MSC.MONY <- read_csv(file = paste(csv_dir, "D1.9.MSC.MONY.csv", sep="/" )) %>%
  mutate(SPI.D1.9.MONY=case_when(
    MONY=="MFSM 2000" | MONY=="MFSMCG 2016"~ 1, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, MONY, SPI.D1.9.MONY  ) %>%
  arrange(date, country)

D1.9.MSC.MONY_wide <- D1.9.MSC.MONY %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('MONY', 'SPI.D1.9.MONY')
              )

write_excel_csv(D1.9.MSC.MONY_wide,
                path = paste(csv_output, "D1.9.MSC.MONY_indicator.csv", sep="/" ))
```



### 1.10 SDDS/e-GDDS subscription

Data Dissemination Standard (SDDS) and electronic General Data Dissemination Standard (e-GDDS) were 
established by the International Monetary Fund (IMF) for member countries that have or that might seek 
access to international capital markets, to guide them in providing their economic and financial data to the public.
Although subscription is voluntary, the subscribing member needs to be committed to observing the standard and provide
information about its data and data dissemination practices (metadata).  The metadata are posted on the IMF's SDDS and 
e-GDDS websites.       

1 Point. Subscribing to IMF SDDS+ or SDDS standards	
0.5 Points. Subscribing to IMF e-GDDS standards	
0 Points. Otherwise

```{r idds}

#read in csv file.
D1.10.MSC.IDDS <- read_csv(file = paste(csv_dir, "D1.10.MSC.IDDS.csv", sep="/" )) %>%
  mutate(SPI.D1.10.IDDS=case_when(
    IDDS=="SDDS Plus" | IDDS=="SDDS"~ 1, 
    IDDS=="e-GDDS"~ 0.5,
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, IDDS, SPI.D1.10.IDDS  ) %>%
  arrange(date, country)

D1.10.MSC.IDDS_wide <- D1.10.MSC.IDDS %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('IDDS', 'SPI.D1.10.IDDS')
              )

write_excel_csv(D1.10.MSC.IDDS_wide,
                path = paste(csv_output, "D1.10.MSC.IDDS_indicator.csv", sep="/" ))
```



### 1.11 CRVS 

Civil registration and vital statistics record the occurrence and characteristics of 
vital events (births, deaths, marriage and divorce etc.) pertaining to the population and 
serve as a main source of vital statistics. This identifies countries that report at least 
90 percent complete registries of vital (birth and death) statistics to the United Nations 
Statistics Division and are reported in its Population and Vital Statistics Reports. 
Countries with complete vital statistics registries may have more accurate and timely demographic indicators. 

1 Point. Vital registration complete	
0 Points. Otherwise
```{r crvs}

#read in csv file.
D1.11.MSC.CRVS <- read_csv(file = paste(csv_dir, "D1.11.MSC.CRVS.csv", sep="/" )) %>%
  mutate(SPI.D1.11.CRVS=case_when(
    str_to_lower(CRVS)=="yes" ~ 1, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, CRVS, SPI.D1.11.CRVS  ) %>%
  arrange(date, country)

D1.11.MSC.CRVS_wide <- D1.11.MSC.CRVS %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('CRVS', 'SPI.D1.11.CRVS')
              )

write_excel_csv(D1.11.MSC.CRVS_wide,
                path = paste(csv_output, "D1.11.MSC.CRVS_indicator.csv", sep="/" ))
```



### 1.12 Business process

The Generic Statistical Business Process Model (GSBPM) aims to describe 
statistics production in a general and process-oriented way.  It is used 
both within and between statistical offices as a common basis for work with 
statistics production in different ways, such as quality, efficiency, standardization, 
and process-orientation.  It is used for all types of surveys, and "business" is not 
related to "business statistics" but refers to the statistical office, simply expressed.  

1 Point. GSBPM is in use
0 Points. Otherwise

```{r gsbp}

#read in csv file.
D1.12.MSC.GSBP <- read_csv(file = paste(csv_dir, "D1.12.MSC.GSBP.csv", sep="/" )) %>%
  mutate(SPI.D1.12.GSBP=case_when(
    str_to_lower(GSBP)=="yes" ~ 1, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, GSBP, SPI.D1.12.GSBP  ) %>%
  arrange(date, country)

D1.12.MSC.GSBP_wide <- D1.12.MSC.GSBP %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('GSBP', 'SPI.D1.12.GSBP')
              )

write_excel_csv(D1.12.MSC.GSBP_wide,
                path = paste(csv_output, "D1.12.MSC.GSBP_indicator.csv", sep="/" ))
```

### MSC Score

MSC Country  Score=Weighted Score÷Maximum Category Score×100

```{r msc}
# join datasets together based on country and date
D1.MSC <- D1.1.MSC.SNAU %>%
  left_join(D1.2.MSC.NABY) %>%
  left_join(D1.3.MSC.CNIN) %>%
  left_join(D1.4.MSC.CPIBY) %>%
  left_join(D1.5.MSC.HOUS) %>%
  left_join(D1.6.MSC.EMPL) %>%
  left_join(D1.7.MSC.CGOV) %>%
  left_join(D1.8.MSC.FINA) %>%
  left_join(D1.9.MSC.MONY) %>%
  left_join(D1.10.MSC.IDDS) %>%
  left_join(D1.11.MSC.CRVS) %>%
  left_join(D1.12.MSC.GSBP) %>%
  select(iso3c, country, date, starts_with("SPI.D1")) 
#Now calculate MSC score which is the average across the 12 indicators
D1.MSC <- D1.MSC %>%
  mutate(SPI.D1.MSC=100*rowMeans(.[grep(x=colnames(D1.MSC), 
                                              pattern="SPI.D1")], na.rm=TRUE)) %>%
  arrange(date, iso3c) %>%
  select(iso3c, country, date,SPI.D1.MSC, starts_with("SPI.D1"))


D1.MSC_wide <- D1.MSC %>%
  select(iso3c, country, date,SPI.D1.MSC) %>%
  pivot_wider(names_from=date,
              names_prefix = "SPI.D1.MSC_",
              values_from=c('SPI.D1.MSC')
              )

write_excel_csv(D1.MSC_wide,
                path = paste(csv_output, "D1.MSC_indicator.csv", sep="/" ))

```

Produce summary statistics of our indicators.

```{r}

msc_sumstats <- D1.MSC %>%
  group_by(date) %>%
  select(SPI.D1.MSC, starts_with("SPI.D1")) %>%
  skim() %>%
  select(c("skim_variable",
           "date", "complete_rate", "numeric.mean",  "numeric.sd",    "numeric.p0",    "numeric.p25",   "numeric.p50",
           "numeric.p75",   "numeric.p100",  "numeric.hist"))

kable(msc_sumstats, caption="Summary Statistics of Methodology, Standards and Classifications Indicator Variables" , col.names = c("Indicator", "Date", "Completion Rate", "Mean",  "Std Dev","Min", "25th Percentile", "Median", "75th Percentile", "Max",  "Histogram"), digits = 2 ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```




Now bring in data on indicators as they were originally computed by SPI team and produce correlations.  Upon inspection, slight difference from 1.0 correlation appears to be due to rounding.

```{r msc_comparison}

orig_data <- read_excel(path="C:/Users/wb469649/Documents/Github/SPI_AKI/Data/FinalCopy of SPI SCORE 2016-2018-DW.xlsx",
                        sheet='Sheet1')


comparison <- D1.MSC_wide %>%
  left_join(orig_data)

#2016
cor(comparison$SPI.D1.MSC_2016, comparison$MSC_2016,
    use='complete.obs')

#2017
cor(comparison$SPI.D1.MSC_2017, comparison$MSC_2017,
    use='complete.obs')

#2018
cor(comparison$SPI.D1.MSC_2018, comparison$MSC_2018,
    use='complete.obs')


```


## SPI Dimension 2: Censuses and Surveys (CS): 

### 2.1 Population & Housing census

Population censuses collect data on the size, distribution and composition of population and 
information on a broad range of social and economic characteristics of the population.  It also 
provides sampling frames for household and other surveys.  Housing censuses provide information 
on the supply of housing units, the structural characteristics and facilities, and health and the 
development of normal family living conditions.  Data obtained as part of the population census, 
including data on homeless persons, are often used in the presentation and analysis of the results 
of the housing census.  It is recommended that population and housing censuses be conducted at least every 10 years. 

1 Point. Population census done within last 10 years	
0.5 Points. Population census done within last 20 years	
0 Points. Otherwise
```{r popu}

#read in csv file.
D2.1.CEN.POPU_df <- read_csv(file = paste(csv_dir, "D2.1.CEN.POPU.csv", sep="/" )) %>%
  group_by(iso3c, country) %>% 
  nest() %>% # The next chunk of code will split our string with the years of the census (i.e. "2000, 2010") in to separate rows.  We will then aggregate up.
  mutate(
    temp_col = map(
      data, 
      ~ str_extract_all(.x$POPU.CENSUS, "\\d{4}") %>% 
        flatten() %>% 
        map_chr(~return(.x)) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(keep_empty = TRUE) %>% # Now we have a database with the observations equal to Country*Census observations.  From here we can calculate latest census, etc.
  mutate(census_date=as.numeric(value)) 



# Now calculate our SPI score for this indicator
for (i in 2016:2018) {
 temp <- D2.1.CEN.POPU_df %>%
  mutate(date=i) %>%
  mutate(recency_indicator=((date>census_date)) ) %>% #restrict to censuses that do not occur after reference date
  mutate(census_date=if_else(recency_indicator==TRUE, census_date, as.numeric(NA))) %>%
  group_by(iso3c, country, date, database_last_updated, POPU.CENSUS ) %>%   
  summarise(last_census=max(census_date, na.rm=T)) %>%
  mutate(SPI.D2.1.POPU=case_when(
    (date-last_census<=10) & (date-last_census>0) ~ 1, 
    (date-last_census<=20) & (date-last_census>0) ~ 0.5, 
    TRUE ~ 0 )
  )  %>%
   ungroup() %>%
  select(iso3c, country, date, POPU.CENSUS, SPI.D2.1.POPU  ) %>%
  arrange(date, country)

  
  assign(paste("D2.1.CEN.POPU",i,sep="_"), temp)
}


D2.1.CEN.POPU<- bind_rows(D2.1.CEN.POPU_2016, D2.1.CEN.POPU_2017, D2.1.CEN.POPU_2018)

D2.1.CEN.POPU_wide <- D2.1.CEN.POPU %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('POPU.CENSUS', 'SPI.D2.1.POPU')
              )

write_excel_csv(D2.1.CEN.POPU_wide,
                path = paste(csv_output, "D2.1.CEN.POPU_indicator.csv", sep="/" ))
```


### 2.2 Agriculture census

Agriculture censuses collect information on agricultural activities, such as
size of holding, land tenure, land use, employment and production, and provide
basic structural data and sampling frames for agricultural surveys.  Censuses
of agriculture normally involves collecting key structural data by complete
enumeration of all agricultural holdings, in combination with more detailed
structural data using sampling methods.  It is recommended that agricultural
censuses be conducted at least every 10 years.

1 Point.  census done within last 10 years	
0.5 Points.  census done within last 20 years	
0 Points. Otherwise

```{r agri}

#read in csv file.
D2.2.CEN.AGRI_df <- read_csv(file = paste(csv_dir, "D2.2.CEN.AGRI.csv", sep="/" )) %>%
  group_by(iso3c, country) %>% 
  nest() %>% # The next chunk of code will split our string with the years of the census (i.e. "2000, 2010") in to separate rows.  We will then aggregate up.
  mutate(
    temp_col = map(
      data, 
      ~ str_extract_all(.x$AGRI.CENSUS, "\\d{4}") %>% 
        flatten() %>% 
        map_chr(~return(.x)) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(keep_empty = TRUE) %>% # Now we have a database with the observations equal to Country*Census observations.  From here we can calculate latest census, etc.
  mutate(census_date=as.numeric(value)) 


# Now calculate our SPI score for this indicator
for (i in 2016:2018) {
 temp <- D2.2.CEN.AGRI_df %>%
  mutate(date=i) %>%
  mutate(recency_indicator=((date>census_date)) ) %>% #restrict to censuses that do not occur after reference date
  mutate(census_date=if_else(recency_indicator==TRUE, census_date, as.numeric(NA))) %>%
  group_by(iso3c, country, date, database_last_updated, AGRI.CENSUS ) %>%   
  summarise(last_census=max(census_date, na.rm=T)) %>%
  mutate(SPI.D2.2.AGRI=case_when(
    (date-last_census<=10) & (date-last_census>0) ~ 1, 
    (date-last_census<=20) & (date-last_census>0) ~ 0.5, 
    TRUE ~ 0 )
  )  %>%
   ungroup() %>%
  select(iso3c, country, date, AGRI.CENSUS, SPI.D2.2.AGRI  ) %>%
  arrange(date, country)

  
  assign(paste("D2.2.CEN.AGRI",i,sep="_"), temp)
}


D2.2.CEN.AGRI<- bind_rows(D2.2.CEN.AGRI_2016, D2.2.CEN.AGRI_2017, D2.2.CEN.AGRI_2018)

D2.2.CEN.AGRI_wide <- D2.2.CEN.AGRI %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('AGRI.CENSUS', 'SPI.D2.2.AGRI')
              )

write_excel_csv(D2.2.CEN.AGRI_wide,
                path = paste(csv_output, "D2.2.CEN.AGRI_indicator.csv", sep="/" ))
```

### 2.3 Business/establishment census

Business/establishment censuses provide valuable information on all economic
activities, number of employed and size of establishments in the economy.
Business Register information is establishment-based and includes business
location, organization type (e.g. subsidiary or parent), industry
classification, and operating data (e.g., receipts and employment).

1 Point.  census done within last 10 years	
0.5 Points.  census done within last 20 years	
0 Points. Otherwise


```{r cen.bizz}

#read in csv file.
D2.3.CEN.BIZZ_df <- read_csv(file = paste(csv_dir, "D2.3.CEN.BIZZ.csv", sep="/" )) %>%
  group_by(iso3c, country) %>% 
  nest() %>% # The next chunk of code will split our string with the years of the census (i.e. "2000, 2010") in to separate rows.  We will then aggregate up.
  mutate(
    temp_col = map(
      data, 
      ~ str_extract_all(.x$BIZZ.CENSUS, "\\d{4}") %>% 
        flatten() %>% 
        map_chr(~return(.x)) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(keep_empty = TRUE) %>% # Now we have a database with the observations equal to Country*Census observations.  From here we can calculate latest census, etc.
  mutate(census_date=as.numeric(value)) 



# Now calculate our SPI score for this indicator
for (i in 2016:2018) {
 temp <- D2.3.CEN.BIZZ_df %>%
  mutate(date=i) %>%
  mutate(recency_indicator=((date>census_date)) ) %>% #restrict to censuses that do not occur after reference date
  mutate(census_date=if_else(recency_indicator==TRUE, census_date, as.numeric(NA))) %>%
  group_by(iso3c, country, date, database_last_updated, BIZZ.CENSUS ) %>%   
  summarise(last_census=max(census_date, na.rm=T)) %>%
  mutate(SPI.D2.3.BIZZ=case_when(
    (date-last_census<=10) & (date-last_census>0) ~ 1, 
    (date-last_census<=20) & (date-last_census>0) ~ 0.5, 
    TRUE ~ 0 )
  )  %>%
   ungroup() %>%
  select(iso3c, country, date, BIZZ.CENSUS, SPI.D2.3.BIZZ  ) %>%
  arrange(date, country)

  
  assign(paste("D2.3.CEN.BIZZ",i,sep="_"), temp)
}


D2.3.CEN.BIZZ<- bind_rows(D2.3.CEN.BIZZ_2016, D2.3.CEN.BIZZ_2017, D2.3.CEN.BIZZ_2018)

D2.3.CEN.BIZZ_wide <- D2.3.CEN.BIZZ %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('BIZZ.CENSUS', 'SPI.D2.3.BIZZ')
              )

write_excel_csv(D2.3.CEN.BIZZ_wide,
                path = paste(csv_output, "D2.3.CEN.BIZZ_indicator.csv", sep="/" ))
```


### 2.4 Household Survey on income/consumption/expenditure/budget/Integrated Survey 

These surveys collect data on household income (including income in kind),
consumption and expenditure.  They typically include income, expenditure, and
consumption surveys, household budget surveys, integrated surveys.  It is
recommended that surveys on income and expenditure be conducted at least every
3 to 5 years.

1 Point. 3 or more surveys done within past 10 years	
0.6 Points. 2 surveys done within past 10 years; 	
0.3 Points. 1 survey done within past 10 years; 	
0 Points. None within past 10 years

```{r svy.hous}

#read in csv file.
D2.4.SVY.HOUS_df <- read_csv(file = paste(csv_dir, "D2.4.SVY.HOUS.csv", sep="/" )) %>%
  group_by(iso3c, country) %>%  # The next chunk of code will split our string with the years of the survey (i.e. "2000, 2010") in to separate rows.  We will then aggregate up.
  nest() %>% 
  mutate(
    temp_col = map(
      data, 
      ~ str_extract_all(.x$HOUS.SURVEYS, "\\d{4}") %>% 
        flatten() %>% 
        map_chr(~return(.x)) %>% 
        as_tibble()
    )
  ) %>%
  unnest(keep_empty = TRUE) %>% # Now we have a database with the observations equal to Country*Census observations.  From here we can calculate latest census, etc.
  mutate(survey_date=as.numeric(value)) 


# Now calculate our SPI score for this indicator
for (i in 2016:2018) {
 temp <- D2.4.SVY.HOUS_df %>%
  mutate(date=i) %>%
  mutate(recency_indicator=((date-survey_date<=10) & (date-survey_date>0)) ) %>% #restrict to surveys inside 10 year period
  group_by(iso3c, country, date, HOUS.SURVEYS) %>% #group by country and create indicator for how many surveys over 10 year period
  summarise(SPI.D2.4.HOUS=case_when(
    sum(recency_indicator)>=3 ~ 1, 
    sum(recency_indicator)==2 ~ 0.6, 
    sum(recency_indicator)==1 ~ 0.3, 
    TRUE ~ 0 )
  )  %>%
  select(iso3c, country, date, HOUS.SURVEYS, SPI.D2.4.HOUS  ) %>%
  arrange(date, country)

  
  assign(paste("D2.4.SVY.HOUS",i,sep="_"), temp)
}

D2.4.SVY.HOUS<- bind_rows(D2.4.SVY.HOUS_2016, D2.4.SVY.HOUS_2017, D2.4.SVY.HOUS_2018)


D2.4.SVY.HOUS_wide <- D2.4.SVY.HOUS %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('HOUS.SURVEYS', 'SPI.D2.4.HOUS')
              )

write_excel_csv(D2.4.SVY.HOUS_wide,
                path = paste(csv_output, "D2.4.SVY.HOUS_indicator.csv", sep="/" ))
```




### 2.5 Agriculture survey

Agricultural surveys refer to surveys of agricultural holdings based on the
sampling frames established by the agricultural census.  These are surveys on
agricultural land, production, crops and livestock, aquaculture, labor and
cost, and time use.  Some issues, such as gender and food security, are of
interest to most agriculture surveys.

1 Point. 3 or more surveys done within past 10 years	
0.6 Points. 2 surveys done within past 10 years; 	
0.3 Points. 1 survey done within past 10 years; 	
0 Points. None within past 10 years


```{r svy.agri}

#read in csv file.
D2.5.SVY.AGRI_df <- read_csv(file = paste(csv_dir, "D2.5.SVY.AGRI.csv", sep="/" )) %>%
  group_by(iso3c, country) %>%  # The next chunk of code will split our string with the years of the survey (i.e. "2000, 2010") in to separate rows.  We will then aggregate up.
  nest() %>% 
  mutate(
    temp_col = map(
      data, 
      ~ str_extract_all(.x$AGRI.SURVEYS, "\\d{4}") %>% 
        flatten() %>% 
        map_chr(~return(.x)) %>% 
        as_tibble()
    )
  ) %>%
  unnest(keep_empty = TRUE) %>% # Now we have a database with the observations equal to Country*Census observations.  From here we can calculate latest census, etc.
  mutate(survey_date=as.numeric(value)) 


# Now calculate our SPI score for this indicator
for (i in 2016:2018) {
 temp <- D2.5.SVY.AGRI_df %>%
  mutate(date=i) %>%
  mutate(recency_indicator=((date-survey_date<=10) & (date-survey_date>0)) ) %>% #restrict to surveys inside 10 year period
  group_by(iso3c, country, date, AGRI.SURVEYS) %>% #group by country and create indicator for how many surveys over 10 year period
  summarise(SPI.D2.5.AGRI=case_when(
    sum(recency_indicator)>=3 ~ 1, 
    sum(recency_indicator)==2 ~ 0.6, 
    sum(recency_indicator)==1 ~ 0.3, 
    TRUE ~ 0 )
  )  %>%
  select(iso3c, country, date, AGRI.SURVEYS, SPI.D2.5.AGRI  ) %>%
  arrange(date, country)

  
  assign(paste("D2.5.SVY.AGRI",i,sep="_"), temp)
}

D2.5.SVY.AGRI<- bind_rows(D2.5.SVY.AGRI_2016, D2.5.SVY.AGRI_2017, D2.5.SVY.AGRI_2018)

D2.5.SVY.AGRI_wide <- D2.5.SVY.AGRI %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('AGRI.SURVEYS', 'SPI.D2.5.AGRI')
              )

write_excel_csv(D2.5.SVY.AGRI_wide,
                path = paste(csv_output, "D2.5.SVY.AGRI_indicator.csv", sep="/" ))
```



### 2.6 Labor Force Survey 

Labor force survey is a standard household-based survey of work-related
statistics at the national and sub-national employment or unemployment levels,
rates or trends.  The surveys also provide the characteristics of the employed
or unemployed, including labor force status by age or gender, breakdowns
between employees and the self-employed, public versus private sector
employment, multiple job-holding, hiring, job creation, and duration of
unemployment.

1 Point. 3 or more surveys done within past 10 years	
0.6 Points. 2 surveys done within past 10 years; 	
0.3 Points. 1 survey done within past 10 years; 	
0 Points. None within past 10 years



```{r svy.labr}

#read in csv file.
D2.6.SVY.LABR_df <- read_csv(file = paste(csv_dir, "D2.6.SVY.LABR.csv", sep="/" )) %>%
  group_by(iso3c, country) %>%  # The next chunk of code will split our string with the years of the survey (i.e. "2000, 2010") in to separate rows.  We will then aggregate up.
  nest() %>% 
  mutate(
    temp_col = map(
      data, 
      ~ str_extract_all(.x$LABR.SURVEYS, "\\d{4}") %>% 
        flatten() %>% 
        map_chr(~return(.x)) %>% 
        as_tibble()
    )
  ) %>%
  unnest(keep_empty = TRUE) %>% # Now we have a database with the observations equal to Country*Census observations.  From here we can calculate latest census, etc.
  mutate(survey_date=as.numeric(value)) 

# Now calculate our SPI score for this indicator
for (i in 2016:2018) {
 temp <- D2.6.SVY.LABR_df %>%
  mutate(date=i) %>%
  mutate(recency_indicator=((date-survey_date<=10) & (date-survey_date>0)) ) %>% #restrict to surveys inside 10 year period
  group_by(iso3c, country, date, LABR.SURVEYS) %>% #group by country and create indicator for how many surveys over 10 year period
  summarise(SPI.D2.6.LABR=case_when(
    sum(recency_indicator)>=3 ~ 1, 
    sum(recency_indicator)==2 ~ 0.6, 
    sum(recency_indicator)==1 ~ 0.3, 
    TRUE ~ 0 )
  )  %>%
  select(iso3c, country, date, LABR.SURVEYS, SPI.D2.6.LABR  ) %>%
  arrange(date, country)

  
  assign(paste("D2.6.SVY.LABR",i,sep="_"), temp)
}

D2.6.SVY.LABR<- bind_rows(D2.6.SVY.LABR_2016, D2.6.SVY.LABR_2017, D2.6.SVY.LABR_2018)

D2.6.SVY.LABR_wide <- D2.6.SVY.LABR %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('LABR.SURVEYS', 'SPI.D2.6.LABR')
              )

write_excel_csv(D2.6.SVY.LABR_wide,
                path = paste(csv_output, "D2.6.SVY.LABR_indicator.csv", sep="/" ))
```




### 2.7 Health/Demographic survey

Health surveys collect information on various aspects of health of
populations, such as health expenditure, access, utilization, and outcomes.
They typically include Demographic and Health Surveys.  It is recommended that
health surveys be conducted at least every 3 to 5 years.

1 Point. 3 or more surveys done within past 10 years	
0.6 Points. 2 surveys done within past 10 years; 	
0.3 Points. 1 survey done within past 10 years; 	
0 Points. None within past 10 years

```{r svy.hlth}

#read in csv file.
D2.7.SVY.HLTH_df <- read_csv(file = paste(csv_dir, "D2.7.SVY.HLTH.csv", sep="/" )) %>%
  group_by(iso3c, country) %>%  # The next chunk of code will split our string with the years of the survey (i.e. "2000, 2010") in to separate rows.  We will then aggregate up.
  nest() %>% 
  mutate(
    temp_col = map(
      data, 
      ~ str_extract_all(.x$HLTH.SURVEYS, "\\d{4}") %>% 
        flatten() %>% 
        map_chr(~return(.x)) %>% 
        as_tibble()
    )
  ) %>%
  unnest(keep_empty = TRUE) %>% # Now we have a database with the observations equal to Country*Census observations.  From here we can calculate latest census, etc.
  mutate(survey_date=as.numeric(value)) 

# Now calculate our SPI score for this indicator
for (i in 2016:2018) {
 temp <- D2.7.SVY.HLTH_df %>%
  mutate(date=i) %>%
  mutate(recency_indicator=((date-survey_date<=10) & (date-survey_date>0)) ) %>% #restrict to surveys inside 10 year period
  group_by(iso3c, country, date, HLTH.SURVEYS) %>% #group by country and create indicator for how many surveys over 10 year period
  summarise(SPI.D2.7.HLTH=case_when(
    sum(recency_indicator)>=3 ~ 1, 
    sum(recency_indicator)==2 ~ 0.6, 
    sum(recency_indicator)==1 ~ 0.3, 
    TRUE ~ 0 )
  )  %>%
  select(iso3c, country, date, HLTH.SURVEYS, SPI.D2.7.HLTH  ) %>%
  arrange(date, country)

  
  assign(paste("D2.7.SVY.HLTH",i,sep="_"), temp)
}


D2.7.SVY.HLTH<- bind_rows(D2.7.SVY.HLTH_2016, D2.7.SVY.HLTH_2017, D2.7.SVY.HLTH_2018)

D2.7.SVY.HLTH_wide <- D2.7.SVY.HLTH %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('HLTH.SURVEYS', 'SPI.D2.7.HLTH')
              )

write_excel_csv(D2.7.SVY.HLTH_wide,
                path = paste(csv_output, "D2.7.SVY.HLTH_indicator.csv", sep="/" ))
```



### 2.8 Business/establishment survey

The business/establishment survey provides information on employment, hours,
and earnings of employees from a sample of business establishments including
private and public, entities that are classified based on an establishment's
principal activity from the business or establishment census.  Establishment
surveys include surveys of businesses, farms, and institutions.  They may ask
for information about the establishment itself and/or employee characteristics
and demographics.

1 Point. 3 or more surveys done within past 10 years	
0.6 Points. 2 surveys done within past 10 years; 	
0.3 Points. 1 survey done within past 10 years; 	
0 Points. None within past 10 years



```{r svy.bizz}

#read in csv file.
D2.8.SVY.BIZZ_df <- read_csv(file = paste(csv_dir, "D2.8.SVY.BIZZ.csv", sep="/" )) %>%
  group_by(iso3c, country) %>%  # The next chunk of code will split our string with the years of the survey (i.e. "2000, 2010") in to separate rows.  We will then aggregate up.
  nest() %>% 
  mutate(
    temp_col = map(
      data, 
      ~ str_extract_all(.x$BIZZ.SURVEYS, "\\d{4}") %>% 
        flatten() %>% 
        map_chr(~return(.x)) %>% 
        as_tibble()
    )
  ) %>%
  unnest(keep_empty = TRUE) %>% # Now we have a database with the observations equal to Country*Census observations.  From here we can calculate latest census, etc.
  mutate(survey_date=as.numeric(value)) 

# Now calculate our SPI score for this indicator

for (i in 2016:2018) {
 temp <- D2.8.SVY.BIZZ_df %>%
  mutate(date=i) %>%
  mutate(recency_indicator=((date-survey_date<=10) & (date-survey_date>0)) ) %>% #restrict to surveys inside 10 year period
  group_by(iso3c, country, date, BIZZ.SURVEYS) %>% #group by country and create indicator for how many surveys over 10 year period
  summarise(SPI.D2.8.BIZZ=case_when(
    sum(recency_indicator)>=3 ~ 1, 
    sum(recency_indicator)==2 ~ 0.6, 
    sum(recency_indicator)==1 ~ 0.3, 
    TRUE ~ 0 )
  )  %>%
  select(iso3c, country, date, BIZZ.SURVEYS, SPI.D2.8.BIZZ  ) %>%
  arrange(date, country)


  assign(paste("D2.8.SVY.BIZZ",i,sep="_"), temp)
}


D2.8.SVY.BIZZ<- bind_rows(D2.8.SVY.BIZZ_2016, D2.8.SVY.BIZZ_2017, D2.8.SVY.BIZZ_2018)

D2.8.SVY.BIZZ_wide <- D2.8.SVY.BIZZ %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('BIZZ.SURVEYS', 'SPI.D2.8.BIZZ')
              )

write_excel_csv(D2.8.SVY.BIZZ_wide,
                path = paste(csv_output, "D2.8.SVY.BIZZ_indicator.csv", sep="/" ))
```



### CS Score

CS Country  Score=Weighted Score÷Maximum Category Score×100

```{r cs}
# join datasets together based on country and date
D2.CS <- D2.1.CEN.POPU %>%
  left_join(D2.2.CEN.AGRI) %>%
  left_join(D2.3.CEN.BIZZ) %>%
  left_join(D2.4.SVY.HOUS) %>%
  left_join(D2.5.SVY.AGRI) %>%
  left_join(D2.6.SVY.LABR) %>%
  left_join(D2.7.SVY.HLTH) %>%
  left_join(D2.8.SVY.BIZZ) %>%
  select(iso3c, country, date, starts_with("SPI.D2")) 

#Now calculate MSC score which is the average across the 12 indicators
D2.CS <- D2.CS %>%
  mutate(SPI.D2.CS=100*rowMeans(.[grep(x=colnames(D2.CS), 
                                              pattern="SPI.D2")], na.rm=TRUE)) %>%
  arrange(date, iso3c) %>%
  select(iso3c, country, date,SPI.D2.CS, starts_with("SPI.D2"))


D2.CS_wide <- D2.CS %>%
  select(iso3c, country, date,SPI.D2.CS) %>%
  pivot_wider(names_from=date,
              names_prefix = "SPI.D2.CS_",
              values_from=c('SPI.D2.CS')
              )

write_excel_csv(D2.CS_wide,
                path = paste(csv_output, "D2.CS_indicator.csv", sep="/" ))

```

Produce summary statistics of our indicators.

```{r}

msc_sumstats <- D2.CS %>%
  group_by(date) %>%
  select(SPI.D2.CS, starts_with("SPI.D2")) %>%
  skim() %>%
  select(c("skim_variable",
           "date", "complete_rate", "numeric.mean",  "numeric.sd",    "numeric.p0",    "numeric.p25",   "numeric.p50",
           "numeric.p75",   "numeric.p100",  "numeric.hist"))

kable(msc_sumstats, caption="Summary Statistics of Census and Surveys Indicator Variables" , col.names = c("Indicator", "Date", "Completion Rate", "Mean",  "Std Dev","Min", "25th Percentile", "Median", "75th Percentile", "Max",  "Histogram"), digits = 2 ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```


Now bring in data on indicators as they were originally computed by SPI team and produce correlations.  Upon inspection, slight difference from 1.0 correlation appears to be due to rounding.

```{r cs_comparison}

comparison_cs <- D2.CS_wide %>%
  left_join(orig_data)

#2016
cor(comparison_cs$SPI.D2.CS_2016, comparison_cs$'C & S_2016',
    use='complete.obs')

#2017
cor(comparison_cs$SPI.D2.CS_2017, comparison_cs$'C & S_2017',
    use='complete.obs')

#2018
cor(comparison_cs$SPI.D2.CS_2018, comparison_cs$'C & S_2018',
    use='complete.obs')


```

## SPI Dimension 3: Availability of Key Indicators (AKI):

```{r data_pulls, echo=TRUE}

##########
# Pull Tags for WDI Data
##########

# make request to World Bank API
wdiRequest <- httr::GET(url = "http://api.worldbank.org/v2/indicator?per_page=20000&format=json&source=2")
wdiResponse <- httr::content(wdiRequest, as = "text", encoding = "UTF-8")

# Parse the JSON content and convert it to a data frame.
wdisJSON <- jsonlite::fromJSON(wdiResponse, flatten = TRUE) %>%
    data.frame()

aki<- c('Poverty headcount ratio at national poverty lines (% of population)',
        'Mortality rate, under-5 (per 1,000 live births)',
        'Immunization, measles (% of children ages 12-23 months)',
        'Primary completion rate, total (% of relevant age group)',
        'Literacy rate, adult total (% of people ages 15 and above)',
        'People using at least basic drinking water services (% of population)',
        'Unemployment, total (% of total labor force) (national estimate)',
        'Manufacturing, value added (% of GDP)',
        'Gross capital formation (% of GDP)',
        'Inflation, GDP deflator (annual %)',
        'Net trade in goods and services (BoP, current US$)',
        'Prevalence of undernourishment (% of population)'  )

get_tag_aki_df<-wdisJSON %>%
  filter(name %in% aki) %>%
  arrange(factor(name, levels = aki))


aki_list<-get_tag_aki_df[,'id']

for (reference_year in 2016:2018) {
  temp <-wbstats::wb(country="countries_only", 
              indicator=aki_list,
              startdate=reference_year-3,
              enddate=reference_year,
              return_wide = T,
              removeNA=FALSE) %>%
          filter(((reference_year-as.numeric(date))<=3) & (reference_year>as.numeric(date))) %>% #filter out years outside reference window of 3 years     
          write_excel_csv(path = paste(csv_output, "/D3.AKI_data_pull_",reference_year,".csv", sep="" )) %>%
          mutate_at(.vars=aki_list, ~if_else(is.na(.),0,1)) %>% #create 0,1 variable for whether data point exists for country
          group_by(country) %>%
          summarise_all((~(if(is.numeric(.)) max(., na.rm = TRUE) else first(.)))) %>% #group by country to create one observation per country                 containing whether or not data point existed
          # Availability of Key Indicator Country Score=Weighted Score÷Maximum Category Score ×100
          mutate(SPI.D3.AKI=100*rowSums(.[aki_list], na.rm=T)/length(aki_list)) %>%
      mutate(date=reference_year) %>%
      select(iso3c, country, date, SPI.D3.AKI, aki_list)


  assign(paste("D3.AKI",reference_year,sep="_"), temp)
}

D3.AKI <- bind_rows(D3.AKI_2016, D3.AKI_2017, D3.AKI_2018)

D3.AKI_wide <- D3.AKI %>%
  select(iso3c, country, date,SPI.D3.AKI) %>%
  pivot_wider(names_from=date,
              names_prefix = "SPI.D3.AKI_",
              values_from=c('SPI.D3.AKI')
              )

write_excel_csv(D3.AKI_wide,
                path = paste(csv_output, "D3.AKI_indicator.csv", sep="/" ))

```



Produce summary statistics of our indicators.

```{r}

msc_sumstats <- D3.AKI %>%
  group_by(date) %>%
  select(SPI.D3.AKI, aki_list) %>%
  skim() %>%
  select(c("skim_variable",
           "date", "complete_rate", "numeric.mean",  "numeric.sd",    "numeric.p0",    "numeric.p25",   "numeric.p50",
           "numeric.p75",   "numeric.p100",  "numeric.hist"))

kable(msc_sumstats, caption="Summary Statistics of Availability of Key Indicator Variables" , col.names = c("Indicator", "Date", "Completion Rate", "Mean",  "Std Dev","Min", "25th Percentile", "Median", "75th Percentile", "Max",  "Histogram"), digits = 2 ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```


Now bring in data on indicators as they were originally computed by SPI team and produce correlations.  There appear to be some differences with original values computed by SPI team

```{r aki_comparison}

comparison_aki <- D3.AKI_wide %>%
  left_join(orig_data)

#2016
cor(comparison_aki$SPI.D3.AKI_2016, comparison_aki$AKI_2016,
    use='complete.obs')

#2017
cor(comparison_aki$SPI.D3.AKI_2017, comparison_aki$AKI_2017,
    use='complete.obs')

#2018
cor(comparison_aki$SPI.D3.AKI_2018, comparison_aki$AKI_2018,
    use='complete.obs')


```

## SPI Dimension 4: Dissemination Practices and Openness (DPO):



### 4.1 NSO has an Advance Release Calendar and it is published 

This indicator refers to a dissemination practice for relevant statistical
data in accordance to the published advance release calendar.  Its presence
provides information on upcoming releases in advance and creates public
awareness; this will lead to more discipline and accountability from the
statistical office.

1 Point. Yes
0 Points. No

```{r cald}

#read in csv file.
D4.1.SC.DPO.CALD <- read_csv(file = paste(csv_dir, "D4.1.SC.DPO.CALD.csv", sep="/" )) %>%
  mutate(SPI.D4.1.CALD=case_when(
    CALD==1 ~ 1, 
    CALD==0 ~ 0, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, CALD, SPI.D4.1.CALD  ) %>%
  arrange(date, country)

D4.1.SC.DPO.CALD_wide <- D4.1.SC.DPO.CALD %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('CALD', 'SPI.D4.1.CALD')
              )

write_excel_csv(D4.1.SC.DPO.CALD_wide,
                path = paste(csv_output, "D4.1.SC.DPO.CALD_indicator.csv", sep="/" ))
```



###  4.2 NSO has a listing of surveys and microdata sets (or NADA)

NSO has a listing of surveys and microdata sets that can provide the necessary
data and reference for follow-up.  Upon well-defined request and procedure per
the national law and practice, users and practitioners can obtain the data
collected from the households and businesses when needed.

1 Point. Yes
0 Points. No

```{r nada}

#read in csv file.
D4.2.SC.DPO.NADA <- read_csv(file = paste(csv_dir, "D4.2.SC.DPO.NADA.csv", sep="/" )) %>%
  mutate(SPI.D4.2.NADA=case_when(
    NADA==1 ~ 1, 
    NADA==0 ~ 0, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, NADA, SPI.D4.2.NADA  ) %>%
  arrange(date, country)

D4.2.SC.DPO.NADA_wide <- D4.2.SC.DPO.NADA %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('NADA', 'SPI.D4.2.NADA')
              )

write_excel_csv(D4.2.SC.DPO.NADA_wide,
                path = paste(csv_output, "D4.2.SC.DPO.NADA_indicator.csv", sep="/" ))
```

### 4.3 NSO has a data portal

This indicator refers to a web-based or stand-alone platform or tools that is
maintained by the NSO and provides access to the indicators and related
metadata in systematic way.

1 Point. Yes
0 Points. No

```{r port}

#read in csv file.
D4.3.SC.DPO.PORT <- read_csv(file = paste(csv_dir, "D4.3.SC.DPO.PORT.csv", sep="/" )) %>%
  mutate(SPI.D4.3.PORT=case_when(
    PORT==1 ~ 1, 
    PORT==0 ~ 0, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, PORT, SPI.D4.3.PORT  ) %>%
  arrange(date, country)

D4.3.SC.DPO.PORT_wide <- D4.3.SC.DPO.PORT %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('PORT', 'SPI.D4.3.PORT')
              )

write_excel_csv(D4.3.SC.DPO.PORT_wide,
                path = paste(csv_output, "D4.3.SC.DPO.PORT_indicator.csv", sep="/" ))
```

### 4.4 Timeseries indicators are available for download in reusable format for free

This indicator will promote usage among the users and bring accountability to
the NSO.  There are several different formats in which a user can access the
data, such as Excel, CSV, and API etc.

1 Point. Yes
0 Points. No

```{r time}

#read in csv file.
D4.4.SC.DPO.TIME <- read_csv(file = paste(csv_dir, "D4.4.SC.DPO.TIME.csv", sep="/" )) %>%
  mutate(SPI.D4.4.TIME=case_when(
    TIME==1 ~ 1, 
    TIME==0 ~ 0, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, TIME, SPI.D4.4.TIME  ) %>%
  arrange(date, country)

D4.4.SC.DPO.TIME_wide <- D4.4.SC.DPO.TIME %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('TIME', 'SPI.D4.4.TIME')
              )

write_excel_csv(D4.4.SC.DPO.TIME_wide,
                path = paste(csv_output, "D4.4.SC.DPO.TIME_indicator.csv", sep="/" ))
```


### 4.5 Metadata is available providing definition, methodology, standards or classifications for existing data series

Statistical systems must be open and transparent about their methods and
procedures and provide access to adequate metadata - detailed descriptions of
the methods and procedures used to produce the data.

1 Point. Yes
0 Points. No

```{r meta}

#read in csv file.
D4.5.SC.DPO.META <- read_csv(file = paste(csv_dir, "D4.5.SC.DPO.META.csv", sep="/" )) %>%
  mutate(SPI.D4.5.META=case_when(
    META==1 ~ 1, 
    META==0 ~ 0, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, META, SPI.D4.5.META  ) %>%
  arrange(date, country)

D4.5.SC.DPO.META_wide <- D4.5.SC.DPO.META %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('META', 'SPI.D4.5.META')
              )

write_excel_csv(D4.5.SC.DPO.META_wide,
                path = paste(csv_output, "D4.5.SC.DPO.META_indicator.csv", sep="/" ))
```

### 4.6 NSO has conducted a user satisfaction survey

Through this indicator a NSO can improve its engagement and dissemination
practice by seeking regular feedback from users and then making necessary
adjustments.  It is also a good practice to continually monitor the changing
data landscape and user needs as well as evolving technologies.


1 Point. Yes
0 Points. No

```{r user}

#read in csv file.
D4.6.SC.DPO.USER <- read_csv(file = paste(csv_dir, "D4.6.SC.DPO.USER.csv", sep="/" )) %>%
  mutate(SPI.D4.6.USER=case_when(
    USER==1 ~ 1, 
    USER==0 ~ 0, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, USER, SPI.D4.6.USER  ) %>%
  arrange(date, country)

D4.6.SC.DPO.USER_wide <- D4.6.SC.DPO.USER %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('USER', 'SPI.D4.6.USER')
              )

write_excel_csv(D4.6.SC.DPO.USER_wide,
                path = paste(csv_output, "D4.6.SC.DPO.USER_indicator.csv", sep="/" ))
```


### 4.7 Geospatial data available on relevant agency website

Geospatial data available on relevant agency website refers to geo-referenced,
location-based disaggregated data from satellite.  Geospatial data are often
used in combination with administrative level national and sub-national units.


1 Point. Yes
0 Points. No

```{r geos}

#read in csv file.
D4.7.SC.DPO.GEOS <- read_csv(file = paste(csv_dir, "D4.7.SC.DPO.GEOS.csv", sep="/" )) %>%
  mutate(SPI.D4.7.GEOS=case_when(
    GEOS==1 ~ 1, 
    GEOS==0 ~ 0, 
    TRUE ~ 0 
  ))  %>%
  select(iso3c, country, date, GEOS, SPI.D4.7.GEOS  ) %>%
  arrange(date, country)

D4.7.SC.DPO.GEOS_wide <- D4.7.SC.DPO.GEOS %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('GEOS', 'SPI.D4.7.GEOS')
              )

write_excel_csv(D4.7.SC.DPO.GEOS_wide,
                path = paste(csv_output, "D4.7.SC.DPO.GEOS_indicator.csv", sep="/" ))
```



### DPO Score

DPO Country  Score=Weighted Score÷Maximum Category Score×100

```{r dpo}
# join datasets together based on country and date
D4.DPO <- D4.1.SC.DPO.CALD %>%
  left_join(D4.2.SC.DPO.NADA) %>%
  left_join(D4.3.SC.DPO.PORT) %>%
  left_join(D4.4.SC.DPO.TIME) %>%
  left_join(D4.5.SC.DPO.META) %>%
  left_join(D4.6.SC.DPO.USER) %>%
  left_join(D4.7.SC.DPO.GEOS) %>%
  select(iso3c, country, date, starts_with("SPI.D4")) 

#Now calculate MSC score which is the average across the 12 indicators
D4.DPO <- D4.DPO %>%
  mutate(SPI.D4.DPO=100*rowMeans(.[grep(x=colnames(D4.DPO), 
                                              pattern="SPI.D4")], na.rm=TRUE)) %>%
  arrange(date, iso3c) %>%
  select(iso3c, country, date,SPI.D4.DPO, starts_with("SPI.D4"))


D4.DPO_wide <- D4.DPO %>%
  select(iso3c, country, date,SPI.D4.DPO) %>%
  pivot_wider(names_from=date,
              names_prefix = "SPI.D4.DPO_",
              values_from=c('SPI.D4.DPO')
              )

write_excel_csv(D4.DPO_wide,
                path = paste(csv_output, "D4.DPO_indicator.csv", sep="/" ))

```

Produce summary statistics of our indicators.

```{r}

msc_sumstats <- D4.DPO %>%
  group_by(date) %>%
  select(SPI.D4.DPO, starts_with("SPI.D4")) %>%
  skim() %>%
  select(c("skim_variable",
           "date", "complete_rate", "numeric.mean",  "numeric.sd",    "numeric.p0",    "numeric.p25",   "numeric.p50",
           "numeric.p75",   "numeric.p100",  "numeric.hist"))

kable(msc_sumstats, caption="Summary Statistics of Dissemination Practices and Openness (DPO) Indicator Variables" , col.names = c("Indicator", "Date", "Completion Rate", "Mean",  "Std Dev","Min", "25th Percentile", "Median", "75th Percentile", "Max",  "Histogram"), digits = 2 ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```



Now bring in data on indicators as they were originally computed by SPI team and produce correlations.  Upon inspection, slight difference from 1.0 correlation appears to be due to rounding.

```{r dpo_comparison}

comparison_dpo <- D4.DPO_wide %>%
  left_join(orig_data)

#2016
cor(comparison_dpo$SPI.D4.DPO_2016, comparison_dpo$DPO_2016,
    use='complete.obs')

#2017
cor(comparison_dpo$SPI.D4.DPO_2017, comparison_dpo$DPO_2017,
    use='complete.obs')

#2018
cor(comparison_dpo$SPI.D4.DPO_2018, comparison_dpo$DPO_2018,
    use='complete.obs')


```


## Overall Score


Total SPI Score =(MSC+CS+DPO+AKI)/4

```{r spi}

#bring all the databases together
SPI<-D1.MSC %>%
  left_join(D2.CS) %>%
  left_join(D3.AKI) %>%
  left_join(D4.DPO) 

#add in country population as last step
# make request to World Bank API
populationRequest <- GET(url = "https://api.worldbank.org/v2/country/all/indicator/SP.POP.TOTL?source=40&per_page=5000&date=2015:2020&format=json")
populationResponse <- content(populationRequest, as = "text", encoding = "UTF-8")

# Parse the JSON content and convert it to a data frame.
pop <- jsonlite::fromJSON(populationResponse, flatten = TRUE) %>%
  data.frame() %>%
  mutate(population=value,
         iso3c=country.id,
         country=country.value,
         date=as.numeric(date)) %>%
  select(iso3c, country, date, population)


#merge population onto SPI
SPI <- SPI %>%
  left_join(pop)

#Construct overall score
SPI <- SPI %>%
  mutate(SPI.OVRL.SCR=(SPI.D1.MSC+SPI.D2.CS+SPI.D3.AKI+SPI.D4.DPO)/4)

#create version of data in wide format
SPI_wide <- SPI %>%
  select(iso3c, country, date, SPI.OVRL.SCR, SPI.D1.MSC, SPI.D2.CS, SPI.D3.AKI, SPI.D4.DPO) %>%
  pivot_wider(names_from=date,
              names_sep = "_",
              values_from=c('SPI.OVRL.SCR', 'SPI.D1.MSC', 'SPI.D2.CS', 'SPI.D3.AKI', 'SPI.D4.DPO')
              )

#label columns
var.labels=c(iso3c='3 digit country code', 
             country='Country Name', 
             date='Date', 
             SPI.D1.MSC='Dimension 1: Methodology, Standards & Classifications (MSC)', 
             SPI.D1.1.SNAU='System of National Accounts in use', 
             SPI.D1.2.NABY='National Accounts base year ', 
             SPI.D1.3.CNIN='Classification of national industry', 
             SPI.D1.4.CPIBY='CPI base year', 
             SPI.D1.5.HOUS='Classification of household consumption', 
             SPI.D1.6.EMPL='Classification of status of employment', 
             SPI.D1.7.CGOV='Central government accounting status', 
             SPI.D1.8.FINA='Compilation of government finance statistics', 
             SPI.D1.9.MONY='Compilation of monetary and financial statistics', 
             SPI.D1.10.IDDS='SDDS/e-GDDS subscription', 
             SPI.D1.11.CRVS='CRVS', 
             SPI.D1.12.GSBP='Business process', 
             SPI.D2.CS='Dimension 2: Censuses and Surveys (CS)', 
             SPI.D2.1.POPU='Population & Housing census', 
             SPI.D2.2.AGRI='Agriculture census', 
             SPI.D2.3.BIZZ='Business/establishment census', 
             SPI.D2.4.HOUS='Household Survey on income/consumption/expenditure/budget/Integrated Survey ', 
             SPI.D2.5.AGRI='Agriculture survey', 
             SPI.D2.6.LABR='Labor Force Survey', 
             SPI.D2.7.HLTH='Health/Demographic survey', 
             SPI.D2.8.BIZZ='Business/establishment survey', 
             SPI.D3.AKI='Dimension 3: Availability of Key Indicators (AKI)', 
             SPI.D3.POV='Poverty headcount ratio at $1.90 a day (2011 PPP) (% of population)',
             SPI.D3.SH.STA.STNT.ZS='Prevalence of stunting, height for age (% of children under 5)',
             SPI.D3.FIES='Food Insecurity Experience Scale',
             SPI.D3.CHLD.MORT='Mortality rate, under-5 (per 1,000 live births)', 
             SPI.D3.SE.LPV.PRIM.BMP='Pupils below minimum reading proficiency at end of primary (%). Low GAML threshold',
             SPI.D3.MMRT='Maternal Mortality',
             SPI.D3.SH.H2O.SMDW.ZS='People using safely managed drinking water services (% of population)',
             SPI.D3.ELEC='Access to electricity (% of population)',
             SPI.D3.SL.UEM.TOTL.NE.ZS='Unemployment, total (% of total labor force) (national estimate)' ,
             SPI.D3.NV.IND.MANF.ZS='Manufacturing, value added (% of GDP)',
             SPI.D3.SI.SPR.PC40.ZG='Annualized average growth rate in per capita real survey mean consumption or income, bottom 40% of population (%)',
             SPI.D3.ER.H2O.FWST.ZS='Level of water stress: freshwater withdrawal as a proportion of available freshwater resources',
             SPI.D3.EG.FEC.RNEW.ZS='Renewable energy consumption (% of total final energy consumption)',
             SPI.D3.EN.ATM.GHGT.KT.CE='Total greenhouse gas emissions (kt of CO2 equivalent)',
             SPI.D3.ER.PTD.TOTL.ZS='Terrestrial and marine protected areas (% of total territorial area)',
             SPI.D3.NE.CON.PRVT.CN='Households and NPISHs Final consumption expenditure (current LCU)',
             SPI.D3.NY.GNP.MKTP.CN='GNI (current LCU)',
             SPI.D3.QUART.GDP='Quarterly GDP',
             SPI.D3.DT.TDS.DPPF.XP.ZS='Debt service (PPG and IMF only, % of exports of goods, services and primary income)', 
             SPI.D4.DPO='Dimension 4: Dissemination Practices & Openness (DPO)', 
             SPI.D4.1.CALD='NSO has an Advance Release Calendar and it is published ', 
             SPI.D4.2.NADA='NSO has a listing of surveys and microdata sets (or NADA)', 
             SPI.D4.3.PORT='NSO has a data portal', 
             SPI.D4.4.TIME='Timeseries indicators are available for download in reusable format for free', 
             SPI.D4.5.META='Metadata is available providing definition, methodology, standards or classifications for existing data series', 
             SPI.D4.6.USER='NSO has conducted a user satisfaction survey', 
             SPI.D4.7.GEOS='Geospatial data available on relevant agency website', 
             SPI.OVRL.SCR='SPI Overall Score')


#label data
#label(SPI) = as.list(var.labels[match(names(SPI), names(var.labels))])

#turn variable labels into data frame 
var.labels.df<-data.frame(var.labels) %>% 
  rownames_to_column() %>%
  rename(variable=rowname)

#export data
write_excel_csv(SPI,
                path = paste(csv_output, "SPI_scores_long.csv", sep="/" ))

# #save to stata with compatible names
# SPI  %>%
#   janitor::clean_names() %>%
#   write_dta(path = paste(csv_output, "SPI_scores.dta", sep="/" ))


write_excel_csv(SPI_wide,
                path = paste(csv_output, "SPI_scores_wide.csv", sep="/" ))

# SPI_wide  %>%
#   janitor::clean_names() %>%
#   write_dta(path = paste(csv_output, "SPI_scores_wide.dta", sep="/" ))
```

# Metadata

```{r metadata}

#turn variable labels into data frame for metadata
metadata <- read_csv(file=paste(csv_dir, "SPI_metadata.csv", sep="/"))

kable(metadata, caption="Metadata for Statistical Performance Index Indicators" ) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  column_spec(1:5, width_max  = "20em")

```


```{r save_R_frame}

#rename the data frames to 
SPI_replication<-SPI
SPI_wide_replication <- SPI_wide
metadata_replication <- metadata

save(SPI_replication, SPI_wide_replication, metadata_replication,
     file = paste(csv_output, "SPI_replication_data.Rdata", sep="/" ))

```


